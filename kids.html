<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>キッズページ - 篠ノ井乗務区</title>
<style>
:root { --main: #ff9800; --bg: #fff9e6; }
body { background: var(--bg); font-family: sans-serif; text-align: center; margin: 0; padding: 0; touch-action: manipulation; overflow-x: hidden; }

/* スコア表示エリア */
.score-area { display: flex; justify-content: space-around; background: #fff; padding: 10px; border-bottom: 3px solid var(--main); }
.score-box { font-weight: bold; }
.score-label { font-size: 0.8rem; color: #666; display: block; }
.score-val { font-size: 1.5rem; color: var(--main); }

.btn { display: block; width: 90%; margin: 10px auto; padding: 18px 0; background: var(--main); color: #fff; text-decoration: none; border-radius: 50px; font-size: 1.4rem; font-weight: bold; border: 5px solid #fff; box-shadow: 0 5px 0 #e68a00; cursor: pointer; }

#game-area { position: relative; width: 95vw; height: 95vw; max-width: 450px; max-height: 450px; margin: 10px auto; background: #000; border: 8px solid var(--main); border-radius: 20px; box-sizing: border-box; }
canvas { width: 100%; height: 100%; display: block; }

/* ポップアップ */
.result-popup { 
    position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
    color: #fff; background: rgba(0,0,0,0.95);
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    z-index: 100; border-radius: 12px;
}
.result-rank { font-size: 2rem; color: #00e676; font-weight: bold; border: 2px solid #00e676; padding: 5px 20px; margin-top: 10px; }

/* 操作ボタン */
.pad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; width: 90%; max-width: 360px; margin: 15px auto; }
.p-btn { aspect-ratio: 1/1; background: #fff; border: 4px solid var(--main); border-radius: 20px; font-size: 2.5rem; display: flex; align-items: center; justify-content: center; color: var(--main); font-weight: bold; }

footer { padding: 20px 0; font-weight: bold; font-size: 0.8rem; border-top: 1px solid #ddd; margin-top: 20px; }
</style>
</head>
<body>

<div class="score-area">
    <div class="score-box"><span class="score-label">ハイスコア</span><span id="hi-score" class="score-val">0</span></div>
    <div class="score-box"><span class="score-label">いまのてんすう</span><span id="now-score" class="score-val">0</span></div>
</div>

<div id="game-area">
    <canvas id="snakeGame" width="400" height="400"></canvas>
    
    <div id="result-popup" class="result-popup" style="display:none;">
        <div id="mode-title" style="font-size: 1.2rem; color: #ff9800;">1にんプレイ</div>
        <div style="font-size: 2rem;" id="res-msg">おわり！</div>
        <div style="font-size: 4rem; color: #ffeb3b;" id="final-score">0</div>
        <div class="result-rank" id="final-rank">みならい</div>
    </div>

    <div id="start-screen" class="result-popup" style="background:rgba(255,152,0,0.9);">
        <span style="font-size: 2rem; margin-bottom: 20px;">あそびかたを えらんでね</span>
        <button class="btn" style="width:80%;" onclick="initGame('solo')">1にんで あそぶ</button>
        <button class="btn" style="width:80%; background:#2196f3; box-shadow:0 5px 0 #1976d2;" onclick="initGame('vs')">2にんで たいせん</button>
    </div>
</div>

<div id="ui" style="display:none;">
    <button id="retry-btn" class="btn" style="background:#4caf50; box-shadow:0 5px 0 #388e3c;" onclick="location.reload()">もういっかい！</button>
</div>

<div class="pad">
    <div></div><div class="p-btn" onclick="setD('U')">↑</div><div></div>
    <div class="p-btn" onclick="setD('L')">←</div>
    <div class="p-btn" onclick="setD('D')">↓</div>
    <div class="p-btn" onclick="setD('R')">→</div>
</div>

<a href="index.html" class="btn" style="background:#666; font-size:1.2rem; box-shadow:0 5px 0 #444;">← もどる</a>

<footer>
    製造元：GitHub / 制作・著作：篠ノ井乗務区
</footer>

<script>
const cvs = document.getElementById("snakeGame");
const ctx = cvs.getContext("2d");
const box = 25;
let snake, food, dir, gameInterval, score, hiScore, mode, p1Score;

// 保存されたハイスコアをよみこむ
hiScore = localStorage.getItem('shinonoi_hi_score') || 0;
document.getElementById('hi-score').innerText = hiScore;

function initGame(m) {
    mode = m;
    p1Score = null;
    startGame();
}

function startGame() {
    score = 0;
    updateScore();
    snake = [{x: 8 * box, y: 8 * box}];
    food = { x: Math.floor(Math.random()*15)*box, y: Math.floor(Math.random()*15)*box };
    dir = "R";
    document.getElementById("result-popup").style.display = "none";
    document.getElementById("start-screen").style.display = "none";
    document.getElementById("ui").style.display = "none";
    if(gameInterval) clearInterval(gameInterval);
    gameInterval = setInterval(draw, 250);
}

function updateScore() {
    document.getElementById("now-score").innerText = score;
}

function getRank(s) {
    if (s >= 150) return "でんせつ";
    if (s >= 100) return "すご腕";
    if (s >= 40) return "一人前";
    return "がんばり屋";
}

function setD(d) {
    if(d=="L" && dir!="R") dir="L";
    if(d=="U" && dir!="D") dir="U";
    if(d=="R" && dir!="L") dir="R";
    if(d=="D" && dir!="U") dir="D";
}

function draw() {
    ctx.fillStyle = "#000"; ctx.fillRect(0,0,400,400);
    snake.forEach((s, i) => {
        ctx.fillStyle = (i==0) ? "#ffeb3b" : "#ff9800";
        ctx.fillRect(s.x, s.y, box, box);
    });
    ctx.fillStyle = "#f44336"; ctx.fillRect(food.x, food.y, box, box);

    let hX = snake[0].x; let hY = snake[0].y;
    if(dir=="L") hX -= box; if(dir=="U") hY -= box;
    if(dir=="R") hX += box; if(dir=="D") hY += box;

    if(hX == food.x && hY == food.y) {
        score += 10;
        updateScore();
        food = { x: Math.floor(Math.random()*15)*box, y: Math.floor(Math.random()*15)*box };
    } else { snake.pop(); }

    let nH = {x: hX, y: hY};
    if(hX<0 || hX>=400 || hY<0 || hY>=400 || snake.some(s => s.x==nH.x && s.y==nH.y)) {
        endGame();
        return;
    }
    snake.unshift(nH);
}

function endGame() {
    clearInterval(gameInterval);
    const pop = document.getElementById("result-popup");
    const fScore = document.getElementById("final-score");
    const fRank = document.getElementById("final-rank");
    const mTitle = document.getElementById("mode-title");
    pop.style.display = "flex";

    if (mode === 'solo') {
        mTitle.innerText = "1にんプレイ";
        fScore.innerText = score;
        fRank.innerText = getRank(score);
        if (score > hiScore) {
            hiScore = score;
            localStorage.setItem('shinonoi_hi_score', hiScore);
            document.getElementById('hi-score').innerText = hiScore;
            fRank.innerText = "新きろく！";
        }
        document.getElementById("ui").style.display = "block";
    } else {
        if (p1Score === null) {
            p1Score = score;
            mTitle.innerText = "1ばんめの ひと おわり";
            fScore.innerText = score;
            fRank.innerText = "つぎの ひと じゅんび！";
            setTimeout(() => {
                alert("つぎは 2ばんめの ひとの ばんです！");
                startGame();
            }, 2000);
        } else {
            mTitle.innerText = "たいせん けっか";
            let res = (score > p1Score) ? "2ばんめの 勝ち！" : (score < p1Score) ? "1ばんめの 勝ち！" : "ひきわけ！";
            fScore.innerText = p1Score + " vs " + score;
            document.getElementById("res-msg").innerText = res;
            fRank.innerText = "なかよく あそぼう";
            document.getElementById("ui").style.display = "block";
        }
    }
}
setTimeout(() => location.reload(), 300000);
</script>
</body>
</html>
