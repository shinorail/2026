<!DOCTYPE html>
<html lang="ja">
<<!DOCTYPE html>
<html lang="ja">
<head>
    <link rel="icon" href="favicon.ico">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>超・スネーク カスタム - 篠ノ井乗務区</title>
    <style>
        :root { --main: #3f51b5; --bg: #f5f5f5; --accent: #ff9800; --text: #333; }
        body { background: var(--bg); color: var(--text); font-family: sans-serif; text-align: center; margin: 0; touch-action: none; overflow-x: hidden; padding-bottom: 200px; }
        
        /* テーマカラー */
        body.theme-classic { --main: #3f51b5; --accent: #ff9800; }
        body.theme-neon { --main: #7b1fa2; --accent: #00bcd4; }
        body.theme-cyber { --main: #2e7d32; --accent: #fbc02d; }

        .score-area { display: flex; justify-content: space-between; padding: 10px 20px; background: #fff; border-bottom: 3px solid var(--main); }
        #game-area { position: relative; width: 90vw; height: 90vw; max-width: 400px; max-height: 400px; margin: 10px auto; background: #fafafa; border: 4px solid var(--main); border-radius: 15px; overflow: hidden; }
        canvas { width: 100%; height: 100%; display: block; }

        .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.98); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 1000; padding: 15px; box-sizing: border-box; overflow-y: auto; }
        .btn { width: 100%; padding: 10px; margin: 4px 0; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 0.9rem; }

        /* 設定項目 */
        .setting-label { font-size: 0.75rem; font-weight: bold; margin: 8px 0 3px; color: var(--main); }
        .btn-group { display: flex; gap: 4px; width: 100%; margin-bottom: 5px; }
        .btn-group button { flex: 1; padding: 8px 2px; font-size: 0.7rem; border: 1px solid #ccc; background: #fff; cursor: pointer; border-radius: 4px; }
        .btn-group button.active { background: var(--main); color: #fff; border-color: var(--main); }

        .list-container { width: 100%; height: 80px; overflow-y: auto; background: #fff; border: 1px solid #ddd; border-radius: 5px; margin-bottom: 5px; }
        .list-item { padding: 8px; border-bottom: 1px solid #eee; cursor: pointer; font-size: 0.8rem; }
        .list-item.selected { background: var(--main); color: #fff; }

        /* ランキング */
        .rank-section { max-width: 400px; margin: 15px auto; padding: 10px; background: #fff; border: 2px solid #333; border-radius: 10px; text-align: left; }
        .rank-row { display: flex; justify-content: space-between; border-bottom: 1px solid #ddd; padding: 4px 0; font-size: 0.75rem; }

        /* おみくじ */
        #kuji-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 99999; display: none; align-items: center; justify-content: center; }
        #kuji-card { background: #fff; border: 8px solid #000; padding: 30px; width: 250px; text-align: center; border-radius: 20px; }

        /* 操作パネル */
        .msg-window { position: fixed; bottom: 15px; left: 50%; transform: translateX(-50%); width: 92%; max-width: 600px; background: #000; border: 3px solid #fff; padding: 12px; z-index: 5000; display: flex; flex-direction: column; }
        .msg-text { color: #fff; font-size: 0.8rem; text-align: left; margin-bottom: 10px; min-height: 2.5em; }
        .btn-row { display: flex; gap: 8px; justify-content: flex-end; }
        .mini-btn { color: #fff; border: 2px solid #fff; padding: 8px 12px; cursor: pointer; font-size: 0.7rem; font-weight: bold; background: #444; text-decoration: none; }

        .pad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; width: 260px; margin: 10px auto; }
        .p-btn { height: 55px; background: #fff; border: 3px solid var(--main); border-radius: 15px; font-size: 1.5rem; display: flex; align-items: center; justify-content: center; color: var(--main); font-weight: bold; }
    </style>
</head>
<body class="theme-classic">

<div class="score-area">
    <div style="font-weight:bold;">STAGE <span id="st-num">1</span></div>
    <div style="font-weight:bold;">SCORE: <span id="now-score">0</span></div>
</div>

<div id="game-area">
    <canvas id="snakeGame" width="400" height="400"></canvas>
    
    <div id="start-screen" class="overlay">
        <div class="setting-label">テーマカラー</div>
        <div class="btn-group">
            <button id="color-classic" class="active" onclick="setTheme('classic')">標準</button>
            <button id="color-neon" onclick="setTheme('neon')">紫色</button>
            <button id="color-cyber" onclick="setTheme('cyber')">緑色</button>
        </div>

        <div class="setting-label">難易度設定</div>
        <div class="btn-group">
            <button id="speed-slow" class="active" onclick="setSpeed(200, 'slow')">ゆっくり</button>
            <button id="speed-fast" onclick="setSpeed(100, 'fast')">はやい</button>
        </div>
        <div class="btn-group">
            <button id="obs-off" class="active" onclick="setObs(false)">障害物なし</button>
            <button id="obs-on" onclick="setObs(true)">障害物あり</button>
        </div>

        <div class="setting-label">乗務員名選択</div>
        <div class="list-container" id="name-selector"></div>
        
        <button class="btn" style="background:var(--main); color:#fff; margin-top:10px;" onclick="gameStart()">運転開始！</button>
        <a href="index.html" style="font-size:0.7rem; color:#888; margin-top:5px;">トップに戻る</a>
    </div>

    <div id="result-popup" class="overlay" style="display:none;">
        <div style="font-size:2.5rem; color:var(--main); font-weight: bold;" id="final-score">0</div>
        <div style="margin-bottom:10px; font-weight:bold;">到達: STAGE <span id="final-st">1</span></div>
        <button class="btn" onclick="saveRanking()" style="background:var(--accent); color:#fff;">記録を保存する</button>
        <button class="btn" style="background:#eee; color:#666;" onclick="location.reload()">タイトルへ</button>
    </div>
</div>

<div class="pad">
    <div></div><div class="p-btn" onclick="setD('U')">↑</div><div></div>
    <div class="p-btn" onclick="setD('L')">←</div><div class="p-btn" onclick="setD('D')">↓</div><div class="p-btn" onclick="setD('R')">→</div>
</div>

<div class="rank-section">
    <div style="font-weight:bold; border-bottom:2px solid #333; margin-bottom:5px; font-size:0.8rem;">最新ランキング TOP5</div>
    <div id="rank-display"></div>
</div>

<div class="msg-window">
    <div class="msg-text" id="talk-box">「2025年もあとわずか。安全運転で終点を目指しましょう。」</div>
    <div class="btn-row">
        <button class="mini-btn" style="background:#ff4500;" onclick="runKuji()">1日1回おみくじ</button>
    </div>
</div>

<div id="kuji-overlay" onclick="closeKuji()">
    <div id="kuji-card">
        <div style="font-size:0.8rem; color:#888;">篠ノ井神社 おみくじ</div>
        <h2 id="luck-txt" style="color:#f00; font-size:4rem; margin:15px 0;"></h2>
        <div style="font-size:0.7rem; color:#666;">[ タップして閉じる ]</div>
    </div>
</div>

<script>
const cvs = document.getElementById("snakeGame");
const ctx = cvs.getContext("2d");
const box = 20;
let snake, food, dir, gameInterval, score, stage, stageEaten, obstacles = [];
let selectedName = "";
let currentBaseSpeed = 200;
let hasObstacles = false;

// 初期化：名前リスト
const names = ["あかぎ","あさま","あずさ","しなの","かがやき","はくたか","こまち","はやぶさ","のぞみ","かいじ"];
const nameBox = document.getElementById("name-selector");
names.forEach(n => {
    const div = document.createElement("div");
    div.className = "list-item";
    div.innerText = n;
    div.onclick = () => {
        document.querySelectorAll('.list-item').forEach(el => el.classList.remove('selected'));
        div.classList.add('selected');
        selectedName = n;
    };
    nameBox.appendChild(div);
});

// 設定変更関数
function setTheme(t) {
    document.body.className = "theme-" + t;
    document.querySelectorAll('.btn-group button[id^="color-"]').forEach(b => b.classList.remove('active'));
    document.getElementById('color-' + t).classList.add('active');
}
function setSpeed(s, id) {
    currentBaseSpeed = s;
    document.querySelectorAll('.btn-group button[id^="speed-"]').forEach(b => b.classList.remove('active'));
    document.getElementById('speed-' + id).classList.add('active');
}
function setObs(o) {
    hasObstacles = o;
    document.getElementById('obs-off').classList.toggle('active', !o);
    document.getElementById('obs-on').classList.toggle('active', o);
}

// ゲーム開始
function gameStart() {
    if(!selectedName) { alert("なまえを選んでください！"); return; }
    document.getElementById("start-screen").style.display = "none";
    score = 0; stage = 1; stageEaten = 0;
    snake = [{x: 10 * box, y: 10 * box}];
    dir = "R";
    obstacles = [];
    spawnFood();
    if(hasObstacles) spawnObstacles();
    runLoop();
}

function spawnFood() {
    food = { x: Math.floor(Math.random()*19)*box, y: Math.floor(Math.random()*19)*box };
    // 障害物やヘビと重ならないように
    if(obstacles.some(o => o.x === food.x && o.y === food.y) || snake.some(s => s.x === food.x && s.y === food.y)) spawnFood();
}

function spawnObstacles() {
    obstacles = [];
    for(let i=0; i < stage + 1; i++) {
        let ox = Math.floor(Math.random()*19)*box;
        let oy = Math.floor(Math.random()*19)*box;
        if(ox !== 10*box && oy !== 10*box) obstacles.push({x: ox, y: oy});
    }
}

function runLoop() {
    if(gameInterval) clearInterval(gameInterval);
    gameInterval = setInterval(draw, Math.max(40, currentBaseSpeed - (stage * 3)));
}

function setD(d) {
    if(d=="L" && dir!="R") dir="L";
    if(d=="U" && dir!="D") dir="U";
    if(d=="R" && dir!="L") dir="R";
    if(d=="D" && dir!="U") dir="D";
}

function draw() {
    ctx.fillStyle = "#fafafa"; ctx.fillRect(0,0,400,400);
    
    // 障害物描画
    ctx.fillStyle = "#333";
    obstacles.forEach(o => ctx.fillRect(o.x, o.y, box-1, box-1));

    // エサ描画
    ctx.fillStyle = "#ff5252";
    ctx.fillRect(food.x, food.y, box-1, box-1);

    // ヘビ描画
    snake.forEach((s, i) => {
        ctx.fillStyle = (i===0) ? "var(--accent)" : "var(--main)";
        ctx.fillRect(s.x, s.y, box-1, box-1);
    });

    let hX = snake[0].x, hY = snake[0].y;
    if(dir=="L") hX -= box; if(dir=="U") hY -= box;
    if(dir=="R") hX += box; if(dir=="D") hY += box;

    // 判定
    if(hX == food.x && hY == food.y) {
        score += 10; stageEaten++;
        document.getElementById("now-score").innerText = score;
        spawnFood();
        if(stageEaten >= 5 && stage < 100) {
            stage++; stageEaten = 0;
            document.getElementById("st-num").innerText = stage;
            if(hasObstacles) spawnObstacles();
            runLoop();
        }
    } else { snake.pop(); }

    let nH = {x: hX, y: hY};
    if(hX<0 || hX>=400 || hY<0 || hY>=400 || 
       snake.some(s => s.x==nH.x && s.y==nH.y) || 
       obstacles.some(o => o.x==nH.x && o.y==nH.y)) {
        clearInterval(gameInterval);
        document.getElementById("result-popup").style.display = "flex";
        document.getElementById("final-score").innerText = score;
        document.getElementById("final-st").innerText = stage;
        return;
    }
    snake.unshift(nH);
}

// ランキング
function saveRanking() {
    const newRecord = { name: selectedName, stage: stage, score: score };
    let ranks = JSON.parse(localStorage.getItem('shino_snake_ranks') || "[]");
    ranks.push(newRecord);
    ranks.sort((a, b) => b.score - a.score);
    localStorage.setItem('shino_snake_ranks', JSON.stringify(ranks.slice(0, 5)));
    displayRanking();
    alert("記録を保存しました！");
    location.reload();
}

function displayRanking() {
    const ranks = JSON.parse(localStorage.getItem('shino_snake_ranks') || "[]");
    const container = document.getElementById('rank-display');
    container.innerHTML = ranks.map((r, i) => `
        <div class="rank-row">
            <span>${i+1}. ${r.name}</span>
            <span>ST.${r.stage} / ${r.score}点</span>
        </div>
    `).join('') || "まだ記録がありません。";
}

// おみくじ
function runKuji() {
    const today = new Date().toLocaleDateString();
    if(localStorage.getItem('shino_kuji_v2') === today) { alert("おみくじは1日1回です。"); return; }
    const res = ["大吉", "中吉", "吉", "小吉", "末吉", "凶"];
    document.getElementById('luck-txt').innerText = res[Math.floor(Math.random() * res.length)];
    document.getElementById('kuji-overlay').style.display = 'flex';
    localStorage.setItem('shino_kuji_v2', today);
}
function closeKuji() { document.getElementById('kuji-overlay').style.display = 'none'; }

// 初期表示
displayRanking();
</script>
</body>
</html>
