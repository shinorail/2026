<!DOCTYPE html>
<html lang="ja">
<head>
    <link rel="icon" href="favicon.ico">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>超・スネーク 100Stages - 篠ノ井乗務区</title>
    <style>
        :root { --main: #3f51b5; --bg: #f5f5f5; --accent: #ff9800; --text: #333; }
        body { background: var(--bg); color: var(--text); font-family: sans-serif; text-align: center; margin: 0; touch-action: none; overflow: hidden; }
        
        body.theme-neon { --main: #7b1fa2; --bg: #f3e5f5; --accent: #00bcd4; }
        body.theme-cyber { --main: #2e7d32; --bg: #e8f5e9; --accent: #fbc02d; }

        .score-area { display: flex; justify-content: space-between; padding: 10px 20px; background: #fff; border-bottom: 3px solid var(--main); }
        #game-area { position: relative; width: 90vw; height: 90vw; max-width: 400px; max-height: 400px; margin: 10px auto; background: #fafafa; border: 4px solid var(--main); border-radius: 15px; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        canvas { width: 100%; height: 100%; display: block; }

        .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.98); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 1000; padding: 15px; box-sizing: border-box; }
        .btn { width: 100%; padding: 12px; margin: 5px 0; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 1.1rem; box-sizing: border-box; }

        .list-container { width: 100%; height: 120px; overflow-y: auto; background: #fff; border: 2px solid #ddd; border-radius: 8px; margin-bottom: 10px; }
        .list-item { padding: 12px; border-bottom: 1px solid #eee; cursor: pointer; text-align: center; }
        .list-item.selected { background: var(--main) !important; color: #fff !important; font-weight: bold; }
        
        .theme-btns { display: flex; gap: 5px; margin-bottom: 10px; width: 100%; }
        .theme-btns button { flex: 1; padding: 10px; font-size: 0.8rem; cursor: pointer; border-radius: 5px; border: 2px solid #ccc; background: #fff; font-weight: bold; }

        .msg-window { position: fixed; bottom: 15px; left: 50%; transform: translateX(-50%); width: 92%; max-width: 600px; background: #000; border: 3px solid #fff; padding: 12px; z-index: 5000; display: flex; flex-direction: column; box-shadow: 0 0 0 4px #000; }
        .msg-text { color: #fff; font-size: 0.8rem; text-align: left; margin-bottom: 10px; min-height: 2.5em; line-height: 1.4; }
        .btn-row { display: flex; gap: 8px; justify-content: flex-end; }
        .mini-btn { color: #fff; border: 2px solid #fff; padding: 8px 12px; cursor: pointer; font-size: 0.7rem; font-weight: bold; background: #444; text-decoration: none; display: inline-block; }

        #kuji-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 10000; display: none; align-items: center; justify-content: center; }
        #kuji-card { background: #fff; border: 8px solid #000; padding: 40px 20px; width: 280px; text-align: center; border-radius: 15px; }

        .pad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; width: 280px; margin: 10px auto; }
        .p-btn { height: 60px; background: #fff; border: 3px solid var(--main); border-radius: 15px; font-size: 2rem; display: flex; align-items: center; justify-content: center; color: var(--main); font-weight: bold; cursor: pointer; -webkit-user-select: none; }
        .p-btn:active { background: var(--main); color: #fff; }
    </style>
</head>
<body class="theme-classic">

<div class="score-area">
    <div style="font-weight:bold;">STAGE <span id="st-num">1</span></div>
    <div style="font-weight:bold;">SCORE: <span id="now-score">0</span></div>
</div>

<div id="game-area">
    <canvas id="snakeGame" width="400" height="400"></canvas>
    
    <div id="start-screen" class="overlay">
        <div class="theme-btns">
            <button onclick="setTheme('classic')">標準</button>
            <button onclick="setTheme('neon')">紫色</button>
            <button onclick="setTheme('cyber')">緑色</button>
        </div>
        <div style="font-size:0.9rem; font-weight:bold; margin-bottom:5px; color:var(--main);">【1】なまえをえらぶ</div>
        <div class="list-container" id="name-selector"></div>
        <button class="btn" style="background:var(--main); color:#fff;" onclick="startGame()">あそぶ！</button>
        <a href="index.html" style="font-size:0.8rem; color:#888; margin-top:10px;">トップメニューへ</a>
    </div>

    <div id="result-popup" class="overlay" style="display:none;">
        <div style="font-size:1.2rem; color:#666;">GAME OVER</div>
        <div style="font-size:4rem; color:var(--main); font-weight: bold; margin: 10px 0;" id="final-score">0</div>
        <div style="margin-bottom:15px; font-weight:bold;">到達ステージ: <span id="final-st">1</span></div>
        <button class="btn" onclick="sendScore()" style="background:var(--accent); color:#fff;">ランキングに記録</button>
        <button class="btn" style="background:#eee; color:#666;" onclick="location.reload()">もういちど遊ぶ</button>
    </div>
</div>

<div class="pad">
    <div></div><div class="p-btn" onclick="setDir('U')">↑</div><div></div>
    <div class="p-btn" onclick="setDir('L')">←</div><div class="p-btn" onclick="setDir('D')">↓</div><div class="p-btn" onclick="setDir('R')">→</div>
</div>

<div class="msg-window">
    <div class="msg-text" id="talk-box">「本日は2025年12月31日。大晦日限定のおみくじは引きましたか？」</div>
    <div class="btn-row">
        <button class="mini-btn" style="background:#ff4500;" onclick="showKuji()">おみくじを引く</button>
        <a href="index.html" class="mini-btn">終了する</a>
    </div>
</div>

<div id="kuji-overlay">
    <div id="kuji-card" onclick="event.stopPropagation()">
        <div style="font-size:0.9rem; color:#888; font-weight:bold;">篠ノ井乗務区 交通安全おみくじ</div>
        <h2 id="luck-txt" style="color:#f00; font-size:5rem; margin:25px 0;"></h2>
        <button class="btn" style="background:#333; color:#fff;" onclick="closeKuji()">とじる</button>
    </div>
</div>

<script>
    const cvs = document.getElementById("snakeGame");
    const ctx = cvs.getContext("2d");
    const box = 20;
    
    let snake = [];
    let food = {x: 0, y: 0};
    let dir = "R";
    let nextDir = "R";
    let score = 0;
    let stage = 1;
    let stageEatCount = 0;
    let gameInterval = null;
    let selectedName = "";

    // 名前リスト作成
    const nameList = ["あかぎ","あさま","あずさ","しなの","かがやき","はくたか","こまち","はやぶさ","のぞみ","つばめ"];
    const nameContainer = document.getElementById("name-selector");
    
    nameList.forEach(name => {
        const item = document.createElement("div");
        item.className = "list-item";
        item.innerText = name;
        item.onclick = () => {
            document.querySelectorAll('.list-item').forEach(el => el.classList.remove('selected'));
            item.classList.add('selected');
            selectedName = name;
        };
        nameContainer.appendChild(item);
    });

    function setTheme(t) {
        document.body.className = "theme-" + t;
    }

    function startGame() {
        if (!selectedName) {
            alert("なまえを選択してください！");
            return;
        }
        document.getElementById("start-screen").style.display = "none";
        score = 0;
        stage = 1;
        stageEatCount = 0;
        resetGameData();
        runLoop();
    }

    function resetGameData() {
        snake = [{x: 10 * box, y: 10 * box}];
        dir = "R";
        nextDir = "R";
        spawnFood();
        updateScoreBoard();
    }

    function spawnFood() {
        food = {
            x: Math.floor(Math.random() * 19 + 1) * box,
            y: Math.floor(Math.random() * 19 + 1) * box
        };
        // ヘビの体の上にエサが出ないようにチェック
        if (snake.some(s => s.x === food.x && s.y === food.y)) spawnFood();
    }

    function runLoop() {
        if (gameInterval) clearInterval(gameInterval);
        // ステージ100に向けて徐々に加速（200msから40msまで）
        const speed = Math.max(40, 200 - (stage * 4));
        gameInterval = setInterval(draw, speed);
    }

    function setDir(d) {
        if (d === "L" && dir !== "R") nextDir = "L";
        if (d === "U" && dir !== "D") nextDir = "U";
        if (d === "R" && dir !== "L") nextDir = "R";
        if (d === "D" && dir !== "U") nextDir = "D";
    }

    function updateScoreBoard() {
        document.getElementById("st-num").innerText = stage;
        document.getElementById("now-score").innerText = score;
    }

    function draw() {
        dir = nextDir;
        ctx.fillStyle = "#fafafa";
        ctx.fillRect(0, 0, cvs.width, cvs.height);

        // エサ描画
        ctx.fillStyle = "#ff5252";
        ctx.fillRect(food.x, food.y, box - 1, box - 1);

        // ヘビ描画
        snake.forEach((part, index) => {
            ctx.fillStyle = (index === 0) ? "getComputedStyle(document.body).getPropertyValue('--accent')" : "getComputedStyle(document.body).getPropertyValue('--main')";
            // CSS変数取得が重い場合があるため固定色も併用
            ctx.fillStyle = (index === 0) ? "#ff9800" : "#3f51b5";
            if(document.body.classList.contains('theme-neon')) ctx.fillStyle = (index === 0) ? "#00bcd4" : "#7b1fa2";
            if(document.body.classList.contains('theme-cyber')) ctx.fillStyle = (index === 0) ? "#fbc02d" : "#2e7d32";
            
            ctx.fillRect(part.x, part.y, box - 1, box - 1);
        });

        let headX = snake[0].x;
        let headY = snake[0].y;

        if (dir === "L") headX -= box;
        if (dir === "U") headY -= box;
        if (dir === "R") headX += box;
        if (dir === "D") headY += box;

        // エサを食べたか
        if (headX === food.x && headY === food.y) {
            score += 10;
            stageEatCount++;
            updateScoreBoard();
            spawnFood();
            
            // 5個食べたらステージアップ
            if (stageEatCount >= 5 && stage < 100) {
                stage++;
                stageEatCount = 0;
                document.getElementById("talk-box").innerText = `「第${stage}ステージ！速度が上がります！」`;
                runLoop();
            }
        } else {
            snake.pop();
        }

        const newHead = {x: headX, y: headY};

        // 衝突判定
        if (headX < 0 || headX >= 400 || headY < 0 || headY >= 400 || snake.some(s => s.x === newHead.x && s.y === newHead.y)) {
            gameOver();
            return;
        }

        snake.unshift(newHead);
    }

    function gameOver() {
        clearInterval(gameInterval);
        document.getElementById("result-popup").style.display = "flex";
        document.getElementById("final-score").innerText = score;
        document.getElementById("final-st").innerText = stage;
    }

    // おみくじ（1日1回）
    function showKuji() {
        const lastDate = localStorage.getItem('shino_kuji_date');
        const today = new Date().toLocaleDateString();

        if (lastDate === today) {
            alert("おみくじは1日1回です。また明日引いてね！");
            return;
        }

        const lucks = ["大吉", "中吉", "吉", "小吉", "末吉", "凶"];
        const result = lucks[Math.floor(Math.random() * lucks.length)];
        
        document.getElementById('luck-txt').innerText = result;
        document.getElementById('kuji-overlay').style.display = 'flex';
        localStorage.setItem('shino_kuji_date', today);
    }

    function closeKuji() {
        document.getElementById('kuji-overlay').style.display = 'none';
    }

    function sendScore() {
        alert(`${selectedName}さんの運行記録（STAGE ${stage} / SCORE ${score}）を送信しました！`);
        window.location.href = "ranking.html";
    }

    // キーボード操作対応
    document.addEventListener("keydown", e => {
        if(e.key === "ArrowUp") setDir("U");
        if(e.key === "ArrowDown") setDir("D");
        if(e.key === "ArrowLeft") setDir("L");
        if(e.key === "ArrowRight") setDir("R");
    });
</script>
</body>
</html>
