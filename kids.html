<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>„Ç≤„Éº„É†„Ç≥„Éº„Éä„Éº - ÁØ†„Éé‰∫ï‰πóÂãôÂå∫</title>
<style>
:root { --main: #3f51b5; --bg: #f0f2f5; --accent: #ff9800; }
body { background: var(--bg); font-family: sans-serif; text-align: center; margin: 0; padding: 0; touch-action: manipulation; }
.score-area { display: flex; justify-content: space-around; background: #fff; padding: 10px; border-bottom: 3px solid var(--main); }
.score-val { font-size: 1.5rem; color: var(--main); font-weight: bold; }
#game-area { position: relative; width: 95vw; height: 95vw; max-width: 400px; max-height: 400px; margin: 10px auto; background: #000; border: 8px solid var(--main); border-radius: 20px; overflow: hidden; }
canvas { width: 100%; height: 100%; }

.result-popup { position: absolute; top: 0; left: 0; width: 100%; height: 100%; color: #fff; background: rgba(0,0,0,0.95); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100; }
.btn { display: block; width: 85%; margin: 8px auto; padding: 15px 0; background: var(--main); color: #fff; border-radius: 50px; font-weight: bold; border: 4px solid #fff; cursor: pointer; }
.btn:disabled { background: #ccc; cursor: not-allowed; border-color: #999; }

.select-label { font-size: 0.9rem; margin-bottom: 5px; color: #fff; font-weight: bold; }
.list-container { width: 85%; height: 120px; overflow-y: scroll; background: #fff; border-radius: 10px; margin-bottom: 10px; padding: 5px; }
.list-item { color: #333; padding: 10px; cursor: pointer; border-bottom: 1px solid #eee; font-size: 1rem; }
.list-item.selected { background: var(--accent); color: #fff; font-weight: bold; border-radius: 5px; }

.pad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; width: 90%; max-width: 320px; margin: 10px auto; }
.p-btn { aspect-ratio: 1/1; background: #fff; border: 4px solid var(--main); border-radius: 20px; font-size: 2rem; display: flex; align-items: center; justify-content: center; color: var(--main); font-weight: bold; }
</style>
</head>
<body>

<div class="score-area">
    <div>‰ªä„ÅÆ„Çπ„Ç≥„Ç¢: <span id="now-score" class="score-val">0</span></div>
</div>

<div id="game-area">
    <canvas id="snakeGame" width="400" height="400"></canvas>
    
    <div id="result-popup" class="result-popup" style="display:none;">
        <div style="font-size: 1.2rem;">‰ªäÂõû„ÅÆ„Çπ„Ç≥„Ç¢</div>
        <div style="font-size: 3.5rem; color: #ffeb3b; font-weight: bold;" id="final-score">0</div>
        <div id="rank-display" style="font-size: 1.3rem; color: #ff9800; margin: 10px 0;"></div>
        
        <button class="btn" id="send-btn" onclick="sendScore()">„É©„É≥„Ç≠„É≥„Ç∞„Å´ÁôªÈå≤„Åô„Çã</button>
        <button class="btn" style="background:#666;" id="retry-btn" onclick="location.reload()">„ÇÇ„ÅÜ‰∏ÄÂ∫¶„ÅÇ„Åù„Å∂</button>
    </div>

    <div id="start-screen" class="result-popup" style="background:var(--main);">
        <div class="select-label">„Å™„Åæ„Åà„Çí„Åà„Çâ„Çì„Åß„Å≠</div>
        <div class="list-container" id="name-selector"></div>
        <div class="select-label">„Ç¢„Ç§„Ç≥„É≥„Çí„Åà„Çâ„Çì„Åß„Å≠</div>
        <div class="list-container" id="icon-selector" style="height: 80px; display: grid; grid-template-columns: repeat(5, 1fr);"></div>
        <button class="btn" onclick="initGame()" id="start-btn">„Ç≤„Éº„É†„Çπ„Çø„Éº„ÉàÔºÅ</button>
    </div>
</div>

<div class="pad">
    <div></div><div class="p-btn" onclick="setD('U')">‚Üë</div><div></div>
    <div class="p-btn" onclick="setD('L')">‚Üê</div><div class="p-btn" onclick="setD('D')">‚Üì</div><div class="p-btn" onclick="setD('R')">‚Üí</div>
</div>

<script>
const cvs = document.getElementById("snakeGame");
const ctx = cvs.getContext("2d");
const box = 25;
let snake, food, dir, gameInterval, score, isSending = false;
let selectedName = "";
let selectedIcon = "";

const names = ["„ÅÇ„Åã„Åé","„ÅÇ„Åï„Åæ","„ÅÇ„Åö„Åï","„ÅÇ„Åö„Åø„ÅÆ","„ÅÑ„Å™„Åò","„Åã„ÅÑ„Åò","„Åã„Åå„ÇÑ„Åç","„Åã„Çâ„Åñ„Çè","„Åç„Åü„Åê„Å´","„Åç„Åù","„Åè„Çç„Çà„Çì","„Åó„Å™„ÅÆ","„Åó„Çâ„ÇÜ„Åç","„Åô„Çè„Åì","„Åù„Çà„Åã„Åú","„Åü„Å¶„ÇÑ„Åæ","„Åü„Å´„Åå„Çè","„Å®„Åç","„Å®„Åå„Åè„Åó","„ÅØ„Åè„Åü„Åã","„ÅØ„Åè„Å∞","„Å≤„ÇÅ„Åã„Çè","„Åµ„Çã„Åï„Å®","„Åø„Åô„Åö","„Åø„Çá„ÅÜ„Åì„ÅÜ","„ÇÇ„Çä„Åä„Åã","„ÇÑ„Åè„ÇÇ","„ÇÑ„Åæ„Å≥„Åì","„ÇÜ„Åë„ÇÄ„Çä","„Çä„Çá„ÅÜ„ÇÇ„ÅÜ","„Çç„Åè„ÇÇ„Çì","„Çè„Åã„Åó„Åä","„Çè„Åã„Å∞","„Ç¢„Ç§„É™„Çπ","„Ç¢„Ç´„Ç∑„Ç¢","„Ç¢„Ç∂„É¨„Ç¢","„Ç¢„Éù„É≠","„Ç™„É™„Ç™„É≥","„Ç´„Ç∑„Ç™„Éö„Ç¢","„Ç´„Éä„É™„Ç¢","„Ç´„É¢„É°","Âåó„Ç¢„É´„Éó„Çπ","ÈäÄÊ≤≥","„Åì„Åæ„Å°","„Çµ„É≥„É©„Ç§„Ç∫","ÂõõÂ≠£Â≥∂","ÂΩóÊòü","„Åô„Åö„Çâ„Çì","„Çπ„Éé„Éº„É©„Éì„ÉÉ„Éà","Â§ßÂ±±","„Å°„Åè„Åæ","„Å§„Å∞„ÇÅ","„Å§„Å∞„Åï","„Å§„Çã„Åé","Âá∫Èõ≤","„Éà„ÉØ„Ç§„É©„Ç§„Éà","„Å™„Åô„ÅÆ","ÊàêÁî∞„Ç®„ÇØ„Çπ„Éó„É¨„Çπ","ÂçóÈ¢®","ËÉΩÁôª","„ÅÆ„Åû„Åø","ÁôΩÈ≥•","„ÅØ„Å§„Åã„Çä","„Å≤„Åã„Çä","„Å≤„Åü„Å°","„Å≤„Å∞„Çä","ÂØåÂ£´","ÂåóÊñó","ÂåóÊñóÊòü","ÂåóÈô∏","„Åª„Åè„Åü„Åã","Ëàû„ÅÑ„ÅÇ„Åå„Çå","„Åæ„Åª„Çç„Å∞","„Åø„Åö„Åª","„Åø„Å°„ÅÆ„Åè","ÊòéÊòü","Â§ïÊúà","Èõ∑È≥•","„É©„Ç§„É©„ÉÉ„ÇØ","„É©„Éô„É≥„ÉÄ„Éº","ÊµÅÊòü","„ÇÜ„ÅÜ„Å•„Çã","„É™„É¨„Éº","„ÇÜ„Åµ„ÅÑ„Çì","„Çè„Åã„Åó„Åä","„Çè„Åó„ÇÖ„ÅÜ","„Åã„ÇÇ„Åó„Åã","„Åã„ÇÇ„ÇÅ","„Åï„Åè„Çâ","„Åï„Å§„Åç","„ÅØ„ÇÑ„Å¶","„ÅØ„ÇÑ„Å∂„Åï","„Åø„Å©„Çä","„ÇÜ„ÅÜ„Åã„Çä","„ÇÜ„ÅÜ„Å™„Åé","Â§ïÊó•","„Çä„Çì„Å©„ÅÜ"];
const icons = ["üöÉ","üöÑ","üöÖ","üöÜ","üöá","üöâ","üöÇ","üöû","üöù","üöå","üöë","üöì","üöï","üöó","üöô","üö≤","üö¢","‚úàÔ∏è","üöÄ","üöÅ","üõ∏","üçé","üçô","üç£","üçî","üçï","‚öΩ","üéÆ","üéπ","üîî"];

const nameBox = document.getElementById("name-selector");
names.forEach(n => {
    const div = document.createElement("div");
    div.className = "list-item";
    div.innerText = n;
    div.onclick = () => {
        document.querySelectorAll('#name-selector .list-item').forEach(el => el.classList.remove('selected'));
        div.classList.add('selected');
        selectedName = n;
    };
    nameBox.appendChild(div);
});

const iconBox = document.getElementById("icon-selector");
icons.forEach(i => {
    const div = document.createElement("div");
    div.className = "list-item";
    div.style.textAlign = "center";
    div.innerText = i;
    div.onclick = () => {
        document.querySelectorAll('#icon-selector .list-item').forEach(el => el.classList.remove('selected'));
        div.classList.add('selected');
        selectedIcon = i;
    };
    iconBox.appendChild(div);
});

function initGame() {
    if (!selectedName || !selectedIcon) { alert("„Å™„Åæ„Åà„Å®„Ç¢„Ç§„Ç≥„É≥„Çí„Åà„Çâ„Çì„Åß„Å≠ÔºÅ"); return; }
    document.getElementById("start-screen").style.display = "none";
    score = 0;
    snake = [{x: 8 * box, y: 8 * box}];
    food = { x: Math.floor(Math.random()*15)*box, y: Math.floor(Math.random()*15)*box };
    dir = "R";
    gameInterval = setInterval(draw, 200);
}

function setD(d) {
    if(d=="L" && dir!="R") dir="L";
    if(d=="U" && dir!="D") dir="U";
    if(d=="R" && dir!="L") dir="R";
    if(d=="D" && dir!="U") dir="D";
}

function draw() {
    ctx.fillStyle = "#000"; ctx.fillRect(0,0,400,400);
    ctx.fillStyle = "#f44336"; ctx.fillRect(food.x, food.y, box, box);
    snake.forEach((s, i) => {
        ctx.fillStyle = (i==0) ? "#ffeb3b" : "#ff9800";
        ctx.fillRect(s.x, s.y, box, box);
    });
    let hX = snake[0].x; let hY = snake[0].y;
    if(dir=="L") hX -= box; if(dir=="U") hY -= box;
    if(dir=="R") hX += box; if(dir=="D") hY += box;
    if(hX == food.x && hY == food.y) {
        score += 10;
        document.getElementById("now-score").innerText = score;
        food = { x: Math.floor(Math.random()*15)*box, y: Math.floor(Math.random()*15)*box };
    } else { snake.pop(); }
    let nH = {x: hX, y: hY};
    if(hX<0 || hX>=400 || hY<0 || hY>=400 || snake.some(s => s.x==nH.x && s.y==nH.y)) {
        clearInterval(gameInterval);
        document.getElementById("result-popup").style.display = "flex";
        document.getElementById("final-score").innerText = score;
        return;
    }
    snake.unshift(nH);
}

function sendScore() {
    if(isSending) return;
    isSending = true;
    const btn = document.getElementById("send-btn");
    btn.innerText = "ÈÄÅ‰ø°‰∏≠...";
    btn.disabled = true;

    const gasUrl = "https://script.google.com/macros/s/AKfycbw1Wmit3zAGi1sYBr-F_a8JnEjepmtZL9CJATnOxSdNp0Uz4UTuKu1kgFK6WmdWQ1US/exec";
    
    fetch(gasUrl, {
        method: "POST",
        body: JSON.stringify({ nickname: selectedName, icon: selectedIcon, score: score })
    })
    .then(res => res.json())
    .then(data => {
        document.getElementById("rank-display").innerHTML = `È†Ü‰Ωç: <span style="font-size:2.5rem;">${data.rank}</span> ‰Ωç / ${data.total}‰∫∫‰∏≠`;
        btn.innerText = "ÁôªÈå≤ÂÆå‰∫ÜÔºÅ";
    })
    .catch(() => {
        btn.innerText = "„Ç®„É©„Éº";
        btn.disabled = false;
        isSending = false;
    });
}
</script>
</body>
</html>
