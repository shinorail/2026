<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç¯ ãƒäº•ä¹—å‹™åŒºã‚¹ãƒãƒ¼ã‚¯ - Googleã‚¹ã‚¿ã‚¤ãƒ«</title>
    <style>
        :root { --grass-light: #aad751; --grass-dark: #a2d149; --snake-head: #4e7cf6; --snake-body: #5285f4; }
        body { background: #4a752c; color: #fff; font-family: sans-serif; text-align: center; margin: 0; overflow-x: hidden; }
        .header { background: #4a752c; display: flex; justify-content: center; gap: 30px; padding: 10px; font-weight: bold; font-size: 1.2rem; }
        #game-container { position: relative; width: 400px; height: 400px; margin: 0 auto; border-radius: 8px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        canvas { display: block; background: var(--grass-light); }
        
        /* ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”»é¢ */
        .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .menu-card { background: #fff; color: #333; padding: 15px; border-radius: 12px; width: 85%; max-width: 320px; max-height: 90%; overflow-y: auto; }
        
        /* ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤ºç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        .rank-list { font-size: 0.8rem; text-align: left; margin: 10px 0; background: #f0f0f0; border-radius: 5px; padding: 5px; }
        .rank-item { display: flex; justify-content: space-between; border-bottom: 1px solid #ccc; padding: 3px 0; }
        
        .btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; margin: 5px 0; }
        .toggle-btn { background: #eee; border: 2px solid #ddd; padding: 6px; border-radius: 6px; cursor: pointer; font-size: 0.75rem; font-weight: bold; }
        .toggle-btn.active { background: #4a752c; color: #fff; border-color: #4a752c; }
        .play-btn { background: #4a752c; color: #fff; border: none; padding: 10px; border-radius: 20px; font-weight: bold; cursor: pointer; width: 100%; margin-top: 5px; }
        
        .controls { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; width: 200px; margin: 10px auto; }
        .dir-btn { height: 50px; background: rgba(255,255,255,0.2); border: 2px solid #fff; border-radius: 50%; color: #fff; display: flex; align-items: center; justify-content: center; cursor: pointer; }
    </style>
</head>
<body>

<div class="header">
    <div>ğŸ <span id="score">0</span></div>
    <div>ğŸš© ST <span id="stage">1</span></div>
</div>

<div id="game-container">
    <canvas id="gameCanvas" width="400" height="400"></canvas>
    
    <div id="start-menu" class="overlay">
        <div class="menu-card">
            <h3 style="margin:0 0 10px; color:#4a752c;">ãƒ©ãƒ³ã‚­ãƒ³ã‚° TOP10</h3>
            <div id="ranking-display" class="rank-list">èª­ã¿è¾¼ã¿ä¸­...</div>
            
            <hr>
            <div style="font-size:0.8rem; margin-bottom:5px;">
                åå‰: <input type="text" id="player-name" value="ã‚ã•ã¾" style="width:100px;">
                ã‚¢ã‚¤ã‚³ãƒ³: <select id="player-icon"><option>ğŸšƒ</option><option>ğŸ</option><option>ğŸ</option></select>
            </div>
            
            <div class="btn-grid">
                <button id="mode-normal" class="toggle-btn active" onclick="setMode('normal')">å£ãªã—</button>
                <button id="mode-obs" class="toggle-btn" onclick="setMode('obs')">éšœå®³ç‰©ã‚ã‚Š</button>
            </div>
            <button class="play-btn" onclick="startGame()">é‹è»¢é–‹å§‹ï¼</button>
        </div>
    </div>
</div>

<div class="controls">
    <div></div><div class="dir-btn" onclick="handleInput('UP')">â†‘</div><div></div>
    <div class="dir-btn" onclick="handleInput('LEFT')">â†</div><div class="dir-btn" onclick="handleInput('DOWN')">â†“</div><div class="dir-btn" onclick="handleInput('RIGHT')">â†’</div>
</div>

<script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbzyxQTPesQAUh_wRKlJQEZREfezzowTRstACYj16yP4_ofPnGZ2rOsQB0tINZ3F6G2r/exec";
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");
    const grid = 20;
    let snake, apple, obstacles, direction, nextDirection, score, stage, isGameOver;
    let config = { mode: 'normal', speed: 120 };

    // èµ·å‹•æ™‚ã«ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’å–å¾—
    window.onload = fetchRanking;

    function fetchRanking() {
        fetch(GAS_URL)
            .then(res => res.json())
            .then(data => {
                const html = data.map((r, i) => `
                    <div class="rank-item">
                        <span>${i+1}. ${r.icon} ${r.nickname}</span>
                        <span>${r.score}ç‚¹</span>
                    </div>
                `).join('');
                document.getElementById('ranking-display').innerHTML = html || "ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“";
            })
            .catch(() => { document.getElementById('ranking-display').innerText = "å–å¾—å¤±æ•—"; });
    }

    function setMode(m) {
        config.mode = m;
        document.getElementById('mode-normal').className = m=='normal'?'toggle-btn active':'toggle-btn';
        document.getElementById('mode-obs').className = m=='obs'?'toggle-btn active':'toggle-btn';
    }

    function startGame() {
        document.getElementById("start-menu").style.display = "none";
        resetGame();
        loop();
    }

    function resetGame() {
        snake = [{x: 160, y: 160}, {x: 140, y: 160}, {x: 120, y: 160}];
        apple = {x: 240, y: 160};
        obstacles = [];
        direction = 'RIGHT'; nextDirection = 'RIGHT';
        score = 0; stage = 1; isGameOver = false;
        if(config.mode === 'obs') spawnObs();
        updateUI();
    }

    function spawnObs() {
        obstacles = [];
        for(let i=0; i<stage; i++) {
            obstacles.push({x: Math.floor(Math.random()*20)*grid, y: Math.floor(Math.random()*20)*grid});
        }
    }

    function updateUI() {
        document.getElementById("score").innerText = score;
        document.getElementById("stage").innerText = stage;
    }

    function handleInput(key) {
        if (key === 'UP' && direction !== 'DOWN') nextDirection = 'UP';
        if (key === 'DOWN' && direction !== 'UP') nextDirection = 'DOWN';
        if (key === 'LEFT' && direction !== 'RIGHT') nextDirection = 'LEFT';
        if (key === 'RIGHT' && direction !== 'LEFT') nextDirection = 'RIGHT';
    }
    window.addEventListener("keydown", e => { if(e.key.includes("Arrow")) handleInput(e.key.replace("Arrow","").toUpperCase()); });

    function loop() {
        if (isGameOver) return;
        direction = nextDirection;
        let head = { ...snake[0] };
        if (direction === 'UP') head.y -= grid;
        if (direction === 'DOWN') head.y += grid;
        if (direction === 'LEFT') head.x -= grid;
        if (direction === 'RIGHT') head.x += grid;

        // è¡çªåˆ¤å®šï¼ˆå£ãƒ»è‡ªåˆ†ãƒ»éšœå®³ç‰©ï¼‰
        if (head.x < 0 || head.x >= 400 || head.y < 0 || head.y >= 400 || 
            snake.some(s => s.x === head.x && s.y === head.y) ||
            obstacles.some(o => o.x === head.x && o.y === head.y)) {
            endGame(); return;
        }

        snake.unshift(head);
        if (head.x === apple.x && head.y === apple.y) {
            score += 10;
            if(score % 50 === 0 && stage < 100) { stage++; if(config.mode==='obs') spawnObs(); }
            updateUI();
            apple = {x: Math.floor(Math.random()*20)*grid, y: Math.floor(Math.random()*20)*grid};
        } else { snake.pop(); }

        draw();
        setTimeout(loop, Math.max(40, config.speed - (stage * 3)));
    }

    function draw() {
        // èƒŒæ™¯ï¼ˆå¸‚æ¾æ¨¡æ§˜ï¼‰
        for(let i=0; i<20; i++) {
            for(let j=0; j<20; j++) {
                ctx.fillStyle = (i+j)%2==0 ? "#aad751":"#a2d149";
                ctx.fillRect(i*grid, j*grid, grid, grid);
            }
        }
        ctx.fillStyle = "#e91e63"; ctx.beginPath(); ctx.arc(apple.x+10, apple.y+10, 8, 0, Math.PI*2); ctx.fill(); // ãƒªãƒ³ã‚´
        ctx.fillStyle = "#573111"; obstacles.forEach(o => ctx.fillRect(o.x+2, o.y+2, 16, 16)); // éšœå®³ç‰©
        snake.forEach((p, i) => { ctx.fillStyle = i==0?"#4e7cf6":"#5285f4"; ctx.fillRect(p.x, p.y, 19, 19); }); // ãƒ˜ãƒ“
    }

    function endGame() {
        isGameOver = true;
        const name = document.getElementById("player-name").value;
        const icon = document.getElementById("player-icon").value;
        const diff = config.mode === 'obs' ? "éšœå®³ç‰©ã‚ã‚Š" : "æ¨™æº–";

        const data = { nickname: name, icon: icon, score: score, difficulty: diff };
        
        document.getElementById('ranking-display').innerText = "ç™»éŒ²ä¸­...";
        fetch(GAS_URL, { method: "POST", body: JSON.stringify(data) })
        .then(res => res.json())
        .then(res => {
            alert(`ç™»éŒ²å®Œäº†ï¼ ã‚ãªãŸã¯ ${res.rank}ä½ / ${res.total}äººä¸­ ã§ã™ï¼`);
            location.reload();
        })
        .catch(() => { alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼"); location.reload(); });
    }
</script>
</body>
</html>
