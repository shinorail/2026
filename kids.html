<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>è¶…ãƒ»ã‚¹ãƒãƒ¼ã‚¯ - ç¯ ãƒäº•ä¹—å‹™åŒº</title>
<style>
:root { --main: #1a237e; --bg: #0a0e14; --accent: #00e5ff; }
body { background: var(--bg); color: #fff; font-family: 'Helvetica Neue', Arial, sans-serif; text-align: center; margin: 0; overflow: hidden; touch-action: none; }

/* ãƒ‡ã‚¶ã‚¤ãƒ³ãƒ†ãƒ¼ãƒ */
body.theme-neon { --main: #d500f9; --bg: #000; --accent: #00e5ff; }
body.theme-cyber { --main: #00c853; --bg: #001200; --accent: #ffea00; }
body.theme-classic { --main: #3f51b5; --bg: #f0f2f5; color: #333; }

.score-area { display: flex; justify-content: space-between; padding: 10px 20px; background: rgba(0,0,0,0.5); border-bottom: 2px solid var(--main); }
.fps-counter { font-size: 0.8rem; color: var(--accent); opacity: 0.7; }

#game-area { position: relative; width: 90vw; height: 90vw; max-width: 400px; max-height: 400px; margin: 10px auto; background: #000; border: 4px solid var(--main); border-radius: 10px; box-shadow: 0 0 20px var(--main); overflow: hidden; }
canvas { width: 100%; height: 100%; }

.overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100; padding: 20px; box-sizing: border-box; }

/* é›£æ˜“åº¦ãƒ»è¨­å®šãƒœã‚¿ãƒ³ */
.btn { width: 100%; padding: 12px; margin: 5px 0; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; transition: 0.2s; }
.btn-diff { background: #333; color: #fff; font-size: 0.9rem; }
.btn-diff.active { background: var(--main); border: 2px solid var(--accent); }
.target-label { font-size: 0.7rem; color: var(--accent); margin-top: -3px; }

.list-container { width: 100%; height: 80px; overflow-y: auto; background: #222; margin: 10px 0; border-radius: 5px; }
.list-item { padding: 8px; font-size: 0.9rem; border-bottom: 1px solid #444; color: #fff; }
.list-item.selected { background: var(--main); }

.pad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; width: 280px; margin: 10px auto; }
.p-btn { height: 60px; background: rgba(255,255,255,0.1); border: 2px solid var(--main); border-radius: 15px; font-size: 1.5rem; display: flex; align-items: center; justify-content: center; color: #fff; }

.theme-selector { display: flex; gap: 5px; margin-bottom: 10px; }
.t-btn { padding: 5px 10px; font-size: 0.7rem; border: 1px solid #fff; border-radius: 3px; cursor: pointer; }
</style>
</head>
<body class="theme-neon">

<div class="score-area">
    <div id="fps" class="fps-counter">FPS: 0</div>
    <div style="font-weight:bold;">SCORE: <span id="now-score" style="color:var(--accent);">0</span></div>
</div>

<div id="game-area">
    <canvas id="snakeGame" width="400" height="400"></canvas>
    
    <div id="start-screen" class="overlay">
        <div class="theme-selector">
            <div class="t-btn" onclick="setTheme('neon')">NEON</div>
            <div class="t-btn" onclick="setTheme('cyber')">CYBER</div>
            <div class="t-btn" onclick="setTheme('classic')">CLASSIC</div>
        </div>
        
        <div style="font-size:0.8rem; margin-bottom:5px;">é›£æ˜“åº¦ã‚’é¸æŠ</div>
        <div id="diff-container" style="width:100%">
            <button class="btn btn-diff active" onclick="setDiff(0)">â˜† å…¥é–€ <div class="target-label">ã¯ã˜ã‚ã¦ã®æ–¹å‘ã‘</div></button>
            <button class="btn btn-diff" onclick="setDiff(1)">â˜†â˜† åˆç´š <div class="target-label">ãªã‚Œã¦ããŸãŠå­æ§˜å‘ã‘</div></button>
            <button class="btn btn-diff" onclick="setDiff(2)">â˜†â˜†â˜† ä¸­ç´š <div class="target-label">æ™®é€šã®é€Ÿã•</div></button>
            <button class="btn btn-diff" onclick="setDiff(3)">â˜†â˜†â˜†â˜† ä¸Šç´š <div class="target-label">ã‚¹ãƒªãƒ«ã‚’æ±‚ã‚ã‚‹æ–¹å‘ã‘</div></button>
            <button class="btn btn-diff" onclick="setDiff(4)">â˜†â˜†â˜†â˜†â˜† ãƒ—ãƒ­ <div class="target-label">é™ç•Œã«æŒ‘æˆ¦ï¼</div></button>
        </div>

        <div class="list-container" id="name-selector"></div>
        <button class="btn" style="background:var(--accent); color:#000; font-size:1.2rem;" onclick="initGame()">START</button>
    </div>

    <div id="result-popup" class="overlay" style="display:none;">
        <div style="font-size: 1rem;">FINISH!</div>
        <div style="font-size: 3.5rem; color: var(--accent); font-weight: bold;" id="final-score">0</div>
        <div id="rank-display" style="font-size: 1.1rem; color: #ffeb3b; margin: 10px 0;"></div>
        <button class="btn" id="send-btn" onclick="sendScore()" style="background:var(--main);">ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã«ç™»éŒ²</button>
        <a href="ranking.html" class="btn" style="background:#444; text-decoration:none; text-align:center;">ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’è¦‹ã‚‹</a>
        <button class="btn" style="background:#222;" onclick="location.reload()">ã‚¿ã‚¤ãƒˆãƒ«ã¸</button>
    </div>
</div>

<div class="pad">
    <div></div><div class="p-btn" onclick="setD('U')">â†‘</div><div></div>
    <div class="p-btn" onclick="setD('L')">â†</div><div class="p-btn" onclick="setD('D')">â†“</div><div class="p-btn" onclick="setD('R')">â†’</div>
</div>

<script>
const cvs = document.getElementById("snakeGame");
const ctx = cvs.getContext("2d");
const box = 20; // ãƒã‚¹ç›®ã‚’ç´°ã‹ã
let snake, food, dir, gameInterval, score, isSending = false;
let selectedName = "", selectedDiff = 0;
let lastTime = 0, fps = 0;

const diffSettings = [
    {speed: 250, label: "â˜† å…¥é–€"},
    {speed: 180, label: "â˜†â˜† åˆç´š"},
    {speed: 120, label: "â˜†â˜†â˜† ä¸­ç´š"},
    {speed: 80, label: "â˜†â˜†â˜†â˜† ä¸Šç´š"},
    {speed: 40, label: "â˜†â˜†â˜†â˜†â˜† ãƒ—ãƒ­"}
];

const names = ["ã‚ã‹ã","ã‚ã•ã¾","ã‚ãšã•","ã—ãªã®","ã‹ãŒã‚„ã","ã¯ããŸã‹","ã“ã¾ã¡","ã¯ã‚„ã¶ã•","ã®ãã¿","ã²ã‹ã‚Š"]; // çŸ­ç¸®è¡¨ç¤º

function setTheme(t) {
    document.body.className = "theme-" + t;
}

function setDiff(idx) {
    selectedDiff = idx;
    const btns = document.querySelectorAll('.btn-diff');
    btns.forEach((b, i) => b.classList.toggle('active', i === idx));
}

// åå‰ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ç”Ÿæˆ
const nameBox = document.getElementById("name-selector");
names.forEach(n => {
    const div = document.createElement("div");
    div.className = "list-item";
    div.innerText = n;
    div.onclick = () => {
        document.querySelectorAll('.list-item').forEach(el => el.classList.remove('selected'));
        div.classList.add('selected');
        selectedName = n;
    };
    nameBox.appendChild(div);
});

function initGame() {
    if (!selectedName) { alert("ãªã¾ãˆã‚’ãˆã‚‰ã‚“ã§ã­ï¼"); return; }
    document.getElementById("start-screen").style.display = "none";
    score = 0;
    snake = [{x: 10 * box, y: 10 * box}];
    food = { x: Math.floor(Math.random()*19)*box, y: Math.floor(Math.random()*19)*box };
    dir = "R";
    
    if(gameInterval) clearInterval(gameInterval);
    gameInterval = setInterval(gameLoop, diffSettings[selectedDiff].speed);
    requestAnimationFrame(updateFPS);
}

function updateFPS(timestamp) {
    if (lastTime) {
        fps = Math.round(1000 / (timestamp - lastTime));
        document.getElementById("fps").innerText = "FPS: " + fps;
    }
    lastTime = timestamp;
    if (gameInterval) requestAnimationFrame(updateFPS);
}

function setD(d) {
    if(d=="L" && dir!="R") dir="L";
    if(d=="U" && dir!="D") dir="U";
    if(d=="R" && dir!="L") dir="R";
    if(d=="D" && dir!="U") dir="D";
}

function gameLoop() {
    ctx.fillStyle = "#000"; ctx.fillRect(0,0,400,400);
    
    // ã‚¨ã‚µã®æç”»
    ctx.fillStyle = "#ff5252";
    ctx.beginPath();
    ctx.arc(food.x + box/2, food.y + box/2, box/2 - 2, 0, Math.PI*2);
    ctx.fill();

    // ãƒ˜ãƒ“ã®æç”»
    snake.forEach((s, i) => {
        ctx.fillStyle = (i==0) ? varColor('--accent') : varColor('--main');
        ctx.fillRect(s.x, s.y, box-1, box-1);
    });

    let hX = snake[0].x; let hY = snake[0].y;
    if(dir=="L") hX -= box; if(dir=="U") hY -= box;
    if(dir=="R") hX += box; if(dir=="D") hY += box;

    if(hX == food.x && hY == food.y) {
        score += (selectedDiff + 1) * 10;
        document.getElementById("now-score").innerText = score;
        food = { x: Math.floor(Math.random()*19)*box, y: Math.floor(Math.random()*19)*box };
    } else { snake.pop(); }

    let nH = {x: hX, y: hY};
    if(hX<0 || hX>=400 || hY<0 || hY>=400 || snake.some(s => s.x==nH.x && s.y==nH.y)) {
        clearInterval(gameInterval);
        gameInterval = null;
        document.getElementById("result-popup").style.display = "flex";
        document.getElementById("final-score").innerText = score;
        return;
    }
    snake.unshift(nH);
}

function varColor(name) {
    return getComputedStyle(document.body).getPropertyValue(name);
}

function sendScore() {
    if(isSending) return;
    isSending = true;
    const btn = document.getElementById("send-btn");
    btn.innerText = "é€ä¿¡ä¸­...";
    btn.disabled = true;

    const gasUrl = "https://script.google.com/macros/s/AKfycbw1Wmit3zAGi1sYBr-F_a8JnEjepmtZL9CJATnOxSdNp0Uz4UTuKu1kgFK6WmdWQ1US/exec";
    
    fetch(gasUrl, {
        method: "POST",
        body: JSON.stringify({ 
            nickname: selectedName, 
            icon: "ğŸ", 
            score: score,
            difficulty: diffSettings[selectedDiff].label
        })
    })
    .then(res => res.json())
    .then(data => {
        document.getElementById("rank-display").innerHTML = `é †ä½: ${data.rank} ä½ / ${data.total}äººä¸­`;
        btn.innerText = "å®Œäº†ï¼";
    })
    .catch(() => { btn.innerText = "ã‚¨ãƒ©ãƒ¼"; isSending = false; btn.disabled = false; });
}
</script>
</body>
</html>
